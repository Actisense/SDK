# Actisense SDK CI/CD Pipeline
# Multi-platform build with C++17, warnings as errors, optional sanitizers

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  # ===========================================================================
  # Windows Build (MSVC)
  # ===========================================================================
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        build_type: [Debug, Release]

    steps:
    - uses: actions/checkout@v4

    - name: Configure CMake
      working-directory: ${{github.workspace}}/code/cpp
      run: >
        cmake -B build
        -DCMAKE_BUILD_TYPE=${{matrix.build_type}}
        -DACTISENSE_BUILD_TESTS=ON
        -DACTISENSE_BUILD_EXAMPLES=ON

    - name: Build
      working-directory: ${{github.workspace}}/code/cpp
      run: cmake --build build --config ${{matrix.build_type}} --parallel

    - name: Test
      working-directory: ${{github.workspace}}/code/cpp/build
      run: ctest -C ${{matrix.build_type}} --output-on-failure --parallel

  # ===========================================================================
  # Linux Build (GCC & Clang)
  # ===========================================================================
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        include:
          - compiler: gcc
            cc: gcc-13
            cxx: g++-13
          - compiler: clang
            cc: clang-17
            cxx: clang++-17

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build
        if [ "${{matrix.compiler}}" = "clang" ]; then
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 17
        fi

    - name: Configure CMake
      working-directory: ${{github.workspace}}/code/cpp
      env:
        CC: ${{matrix.cc}}
        CXX: ${{matrix.cxx}}
      run: >
        cmake -B build -G Ninja
        -DCMAKE_BUILD_TYPE=${{matrix.build_type}}
        -DACTISENSE_BUILD_TESTS=ON
        -DACTISENSE_BUILD_EXAMPLES=ON

    - name: Build
      working-directory: ${{github.workspace}}/code/cpp
      run: cmake --build build --parallel

    - name: Test
      working-directory: ${{github.workspace}}/code/cpp/build
      run: ctest --output-on-failure --parallel

  # ===========================================================================
  # Linux Sanitizer Build (ASan + UBSan)
  # ===========================================================================
  linux-sanitizers:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build

    - name: Configure CMake with Sanitizers
      working-directory: ${{github.workspace}}/code/cpp
      env:
        CC: gcc-13
        CXX: g++-13
      run: >
        cmake -B build -G Ninja
        -DCMAKE_BUILD_TYPE=Debug
        -DACTISENSE_BUILD_TESTS=ON
        -DACTISENSE_ENABLE_SANITIZERS=ON

    - name: Build
      working-directory: ${{github.workspace}}/code/cpp
      run: cmake --build build --parallel

    - name: Test with Sanitizers
      working-directory: ${{github.workspace}}/code/cpp/build
      env:
        ASAN_OPTIONS: detect_leaks=1:strict_string_checks=1
        UBSAN_OPTIONS: print_stacktrace=1
      run: ctest --output-on-failure --parallel

  # ===========================================================================
  # macOS Build (AppleClang)
  # ===========================================================================
  macos:
    runs-on: macos-latest
    strategy:
      matrix:
        build_type: [Debug, Release]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install ninja

    - name: Configure CMake
      working-directory: ${{github.workspace}}/code/cpp
      run: >
        cmake -B build -G Ninja
        -DCMAKE_BUILD_TYPE=${{matrix.build_type}}
        -DACTISENSE_BUILD_TESTS=ON
        -DACTISENSE_BUILD_EXAMPLES=ON

    - name: Build
      working-directory: ${{github.workspace}}/code/cpp
      run: cmake --build build --parallel

    - name: Test
      working-directory: ${{github.workspace}}/code/cpp/build
      run: ctest --output-on-failure --parallel

  # ===========================================================================
  # Code Quality Checks
  # ===========================================================================
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install clang-format and clang-tidy
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 17
        sudo apt-get install -y clang-format-17 clang-tidy-17

    - name: Check formatting
      working-directory: ${{github.workspace}}/code/cpp
      run: |
        find src -name '*.cpp' -o -name '*.hpp' | xargs clang-format-17 --dry-run --Werror

    # Note: clang-tidy requires compile_commands.json, generated during CMake configure
    - name: Configure for clang-tidy
      working-directory: ${{github.workspace}}/code/cpp
      run: >
        cmake -B build
        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        -DACTISENSE_BUILD_TESTS=OFF

    - name: Run clang-tidy
      working-directory: ${{github.workspace}}/code/cpp
      run: |
        find src -name '*.cpp' | xargs clang-tidy-17 -p build --warnings-as-errors='*' || true
